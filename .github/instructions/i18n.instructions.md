# px2-clover 多言語対応（i18n）インストラクション

## 概要

px2-cloverでは、管理画面の多言語対応（国際化、i18n）機能を提供しています。ユーザーは自分の言語設定に基づいて、管理画面の表示言語を選択できます。

## 対応言語

現在、以下の言語に対応しています：

- **en** - English（英語）
- **ja** - Japanese（日本語）
- **zh** - Chinese（中国語・簡体字）
- **zh-TW** - Traditional Chinese（中国語・繁体字）

> **注意**: 一部の翻訳キーは、すべての言語に対して翻訳が完了していない場合があります。未翻訳の場合は、デフォルト言語（通常は日本語）が表示されます。

## 言語データファイル

### ファイル構造

```
data/language.csv
```

CSV形式で翻訳データを管理しています。1行目がヘッダー行で、各列が言語コードを表します：

```csv
,en,ja,zh,zh-TW
page_title.dashboard,"Dashboard","ダッシュボード",,
ui_label.save,Save,保存する,保存,保存
```

### 翻訳キーの命名規則

翻訳キーは、ドット（`.`）区切りの階層構造になっています：

- `page_title.*` - ページタイトル
- `modal_title.*` - モーダルタイトル
- `ui_label.*` - UIラベル
- `ui_message.*` - UIメッセージ
- `login_error.*` - ログインエラーメッセージ
- `error_message.*` - エラーメッセージ
- `role.*` - ロール名
- `system_module_label.*` - システムモジュールラベル

### 翻訳データの追加方法

1. **CSVファイルを編集**
   ```csv
   ,en,ja,zh,zh-TW
   ui_label.new_feature,"New Feature","新機能",新功能,新功能
   ```

2. **すべての言語列に値を入力**
   - 空のセルがある場合、その言語では翻訳が表示されません
   - デフォルト言語（通常は日本語）がフォールバックとして使用されます

3. **特殊文字のエスケープ**
   - ダブルクォートを含む文字列は、ダブルクォートで囲む必要があります
   - 例: `"Delete blog ""{{ blogName }}"""`

## 言語の決定順序

システムは以下の順序で言語を決定します：

1. **リクエストパラメータ** `ADMIN_USER_LANG`
   - URLパラメータとして指定された場合、最優先で使用されます
   - 例: `?PX=admin&ADMIN_USER_LANG=en`

2. **ログインユーザーの言語設定**
   - ユーザープロファイルに保存されている `lang` フィールド
   - プロフィール設定画面（`/?PX=admin.config_profile`）で変更可能

3. **Pickles 2のデフォルト言語**
   - `$conf->default_lang` の設定値
   - ダッシュボードから確認・変更可能

## 実装の詳細

### 1. バックエンド（PHP）

#### 言語ヘルパー（php/helpers/lang.php）

```php
namespace tomk79\pickles2\px2clover\helpers;

class lang {
    private $lb; // LangBankオブジェクト
    
    public function __construct( $clover ){
        $this->lb = new \tomk79\LangBank(__DIR__.'/../../data/language.csv');
        
        // 言語の決定
        if( strlen($this->px->req()->get_param('ADMIN_USER_LANG') ?? '') ){
            $this->lb->setLang( $this->px->req()->get_param('ADMIN_USER_LANG') );
        }elseif( strlen($this->loginUserInfo->lang ?? '') ){
            $this->lb->setLang( $this->loginUserInfo->lang );
        }else{
            $this->lb->setLang( $this->px->lang() );
        }
    }
    
    public function get($key){
        return $this->lb->get($key);
    }
    
    public function getLang(){
        return $this->lb->getLang();
    }
}
```

#### Twigテンプレートでの使用

Twigテンプレートでは、`lb` オブジェクトが自動的に渡されます：

```twig
{# ページタイトル #}
<h1>{{ lb.get('page_title.dashboard') }}</h1>

{# UIラベル #}
<label>{{ lb.get('ui_label.save') }}</label>

{# エラーメッセージ #}
<p class="error">{{ lb.get('error_message.required') }}</p>
```

#### ビュー処理（php/view.php）

```php
$data['lb'] = $this->clover->lang(); // LangBankオブジェクトをテンプレートに渡す
```

### 2. フロントエンド（React/JavaScript）

#### LangBankの初期化（src/cloverMain/cloverMain.jsx）

```javascript
import LangBank from 'langbank';
const languageCsv = require('../../data/language.csv');

// LangBankの初期化
const lb = new LangBank(languageCsv, ()=>{
    const lang = ( newState.profile && newState.profile.lang ? newState.profile.lang : "ja");
    lb.setLang( lang );
    newState.cloverUtils.setLang( lang );
    newState.cloverUtils.setLangbank( lb );
    newState.lb = lb;
    newState.lbLoaded = true;
});
```

#### Reactコンポーネントでの使用

Reactコンポーネントでは、`main.lb` オブジェクトを通じて翻訳を取得します：

```jsx
import React from 'react';

function MyComponent({ main }) {
    return (
        <div>
            <h1>{main.lb.get('page_title.dashboard')}</h1>
            <button>{main.lb.get('ui_label.save')}</button>
        </div>
    );
}
```

#### CloverUtilsでの使用（src/_libs/CloverUtils.js）

```javascript
export default function CloverUtils(){
    this.lang = "ja";
    let lb;
    
    this.setLang = function(lang){
        this.lang = lang;
    }
    
    this.setLangbank = function(langbank){
        lb = langbank;
    }
    
    // Twigテンプレート処理時にLangBankを渡す
    this.bindTwig = function( templateSrc, bindData ){
        bindData = {
            ...bindData,
            lb: lb, // LangBankオブジェクトを渡す
        };
        return template.render(bindData);
    }
}
```

### 3. テンプレート内での使用

#### Twigテンプレート（React内で使用）

Reactコンポーネント内でTwigテンプレートをレンダリングする場合：

```jsx
const template = main.cloverUtils.bindTwig(
    templateSource,
    {
        main: main,
        values: formValues,
        errors: validationErrors,
        // lb は自動的に追加される
    }
);
```

テンプレート内では：

```twig
<label>{{ main.lb.get('ui_label.user_name') }}</label>
<input type="text" name="name" value="{{ values.name|e }}" />
{% if errors.name %}
    <p class="error">{{ errors.name[0]|e }}</p>
{% endif %}
```

## 依存パッケージ

### PHP版

- **tomk79/langbank** (`~0.2`)
  - Composer経由でインストール
  - `composer.json` に定義済み

### Node.js版

- **langbank** (`github:tomk79/node-langbank.git#develop`)
  - npm経由でインストール
  - `package.json` に定義済み
  - Webpackの `csv-loader` でCSVファイルを読み込み

## ユーザー設定

### プロフィール設定画面

ユーザーはプロフィール設定画面（`/?PX=admin.config_profile`）で言語を変更できます：

```jsx
<select id="input-lang" name="lang" defaultValue={main.profile.lang}>
    <option value="en">English</option>
    <option value="ja">Japanese</option>
</select>
```

### データ保存

ユーザーの言語設定は、`php/helpers/auth.php` で保存されます：

```php
$write_data->lang = $new_profile->lang ?? null;
```

## 開発ガイドライン

### 新しい翻訳キーを追加する場合

1. **CSVファイルに追加**
   ```csv
   ,en,ja,zh,zh-TW
   ui_label.my_new_feature,"My New Feature","新機能",新功能,新功能
   ```

2. **コードで使用**
   ```php
   // PHP
   $this->clover->lang()->get('ui_label.my_new_feature');
   ```
   
   ```jsx
   // React
   {main.lb.get('ui_label.my_new_feature')}
   ```
   
   ```twig
   {# Twig #}
   {{ lb.get('ui_label.my_new_feature') }}
   ```

### 新しい言語を追加する場合

1. **CSVファイルのヘッダーに列を追加**
   ```csv
   ,en,ja,zh,zh-TW,ko
   ```

2. **すべての翻訳キーに翻訳を追加**
   - 空のセルがある場合、その言語では翻訳が表示されません

3. **言語選択UIに追加**
   - `src/cloverMain/views/ConfigProfile.jsx` の言語選択セレクトボックスに追加
   - `src/cloverMain/views/ConfigMembers_files/templates/edit.twig` にも追加

### 動的な値を含む翻訳

一部の翻訳キーには、動的な値（プレースホルダー）が含まれています：

```csv
ui_label.delete_blog_{{blogName}},"Delete blog ""{{ blogName }}""","ブログ ""{{ blogName }}"" を削除する",,
```

使用時は、LangBankの機能を使用して値を置換します：

```javascript
// LangBankが自動的に置換を処理する場合
main.lb.get('ui_label.delete_blog_{{blogName}}', { blogName: 'My Blog' });
```

> **注意**: 現在の実装では、すべての動的値置換がサポートされているわけではありません。必要に応じて、コード側で文字列置換を行う必要があります。

## トラブルシューティング

### 翻訳が表示されない場合

1. **CSVファイルの構文を確認**
   - ヘッダー行が正しいか確認
   - ダブルクォートのエスケープが正しいか確認
   - カンマの位置が正しいか確認

2. **翻訳キーが正しいか確認**
   - キー名のタイポがないか確認
   - 大文字・小文字が正しいか確認

3. **言語設定を確認**
   - ユーザーの言語設定が正しく保存されているか確認
   - リクエストパラメータが正しく設定されているか確認

4. **LangBankの初期化を確認**
   - フロントエンドで `main.lb` が正しく初期化されているか確認
   - バックエンドで `$this->clover->lang()` が正しく動作しているか確認

### 一部の言語で翻訳が表示されない場合

1. **CSVファイルの該当列に値が入力されているか確認**
   - 空のセルがある場合、その言語では翻訳が表示されません

2. **デフォルト言語の設定を確認**
   - フォールバックとして使用されるデフォルト言語が正しく設定されているか確認

### ビルドエラーが発生する場合

1. **CSV Loaderの設定を確認**
   - `webpack.mix.js` で `csv-loader` が正しく設定されているか確認

2. **依存パッケージを確認**
   - `npm install` が正しく実行されているか確認
   - `composer install` が正しく実行されているか確認

## テスト方法

### 手動テスト

1. **管理画面にログイン**
   - プロフィール設定画面に移動

2. **言語設定を変更**
   - 異なる言語を選択して保存

3. **ページをリロード**
   - 管理画面の表示が選択した言語に変更されることを確認

4. **各ページを確認**
   - すべてのページで翻訳が正しく表示されることを確認

### 自動テスト

現在、多言語対応に関する自動テストは実装されていません。必要に応じて追加を検討してください。

## 関連ファイル一覧

### データファイル
- `data/language.csv` - 翻訳データ（CSV形式）

### PHPファイル
- `php/helpers/lang.php` - 言語ヘルパークラス
- `php/view.php` - ビュー処理（LangBankオブジェクトをテンプレートに渡す）
- `php/helpers/auth.php` - 認証処理（ユーザー言語設定の保存・読み込み）
- `php/register.php` - プラグイン登録（初期化時の言語設定）
- `php/initializer.php` - 初期化処理（言語設定）

### JavaScript/Reactファイル
- `src/cloverMain/cloverMain.jsx` - メインエントリポイント（LangBank初期化）
- `src/_libs/CloverUtils.js` - 共通ユーティリティ（LangBank管理）
- `src/cloverMain/views/ConfigProfile.jsx` - プロフィール設定UI（言語選択）
- `src/cloverMain/views/ConfigMembers_files/templates/edit.twig` - メンバー編集テンプレート（言語選択）

### テンプレートファイル
- `templates/layouts/default.twig` - デフォルトレイアウト（言語属性の設定）
- `templates/layouts/plain.twig` - プレーンレイアウト（言語属性の設定）
- `templates/layouts/auth.twig` - 認証レイアウト（言語属性の設定）

### 設定ファイル
- `composer.json` - PHP依存関係（tomk79/langbank）
- `package.json` - Node.js依存関係（langbank）
- `webpack.mix.js` - ビルド設定（CSV Loader）

## 今後の改善案

1. **翻訳の完全性向上**
   - すべての言語で翻訳を完成させる
   - 翻訳の品質向上

2. **動的値の置換機能強化**
   - LangBankの機能を活用した、より柔軟な動的値置換

3. **翻訳管理ツール**
   - 翻訳の管理を容易にするツールの追加
   - 翻訳の検証機能

4. **自動テストの追加**
   - 翻訳キーの存在確認
   - 翻訳の表示確認

5. **言語の追加**
   - より多くの言語への対応
   - 言語の追加プロセスの簡素化

6. **翻訳の外部化**
   - 翻訳データを外部ファイルやデータベースから読み込む機能

---

このインストラクションに従うことで、px2-cloverの多言語対応機能を理解し、適切に拡張・修正することができます。

